name: Encrypt Message

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - "messages/**"
      - "sealed/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  encrypt:
    runs-on: ubuntu-latest
    # Skip bot PRs (Dependabot, Vercel, GitHub Actions, etc.)
    if: |
      github.event.pull_request.user.login != 'dependabot[bot]' &&
      github.event.pull_request.user.login != 'vercel[bot]' &&
      github.event.pull_request.user.login != 'github-actions[bot]' &&
      !contains(github.event.pull_request.user.login, '[bot]')

    steps:
      - name: Comment Processing
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸ”„ Processing Your Time Capsule Message

            <div align="center">

            ![Status](https://img.shields.io/badge/Status-Processing-yellow?style=for-the-badge)

            </div>

            ---

            ### ğŸ“‹ What's Happening:

            | Step | Status | Description |
            |------|--------|-------------|
            | ğŸ” | â³ **In Progress** | Validating submission |
            | ğŸ” | â³ **Queued** | Encrypting with GPG |
            | ğŸ’¾ | â³ **Queued** | Saving to vault |
            | âœ… | â³ **Queued** | Finalizing |

            ---

            > â° **Please wait...** This usually takes 10-20 seconds.

            *ğŸ¤– Automated by GitHub Actions*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      # Checkout PR head (user's submission)
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr-content

      - name: Extract username
        id: user
        run: |
          echo "username=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT

      - name: Check submission and encrypt
        id: process
        env:
          GPG_KEY: ${{ secrets.GPG_PUBLIC_KEY }}
        run: |
          USERNAME="${{ steps.user.outputs.username }}"

          # Check for message file (supports username.txt or username-N.txt pattern)
          MESSAGE_FILE=""
          if [ -f "pr-content/messages/${USERNAME}.txt" ]; then
            MESSAGE_FILE="pr-content/messages/${USERNAME}.txt"
          else
            # Look for username-*.txt pattern
            for f in pr-content/messages/${USERNAME}-*.txt; do
              if [ -f "$f" ]; then
                MESSAGE_FILE="$f"
                break
              fi
            done
          fi

          if [ -n "$MESSAGE_FILE" ]; then
            echo "type=plaintext" >> $GITHUB_OUTPUT
            echo "âœ… Found message: $MESSAGE_FILE"
            
            # Setup GPG
            echo "$GPG_KEY" | gpg --import
            
            # Encrypt
            mkdir -p /tmp/sealed-output
            TS=$(date +%Y%m%d-%H%M%S)
            
            gpg --encrypt \
                --recipient "time-capsule-2035" \
                --armor \
                --trust-model always \
                --output "/tmp/sealed-output/${USERNAME}-${TS}.gpg" \
                "$MESSAGE_FILE"
            
            echo "sealed_folder=/tmp/sealed-output" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for pre-sealed files
          if [ -d "pr-content/sealed/${USERNAME}" ]; then
            echo "type=sealed" >> $GITHUB_OUTPUT
            echo "âœ… Found pre-sealed message"
            cp -r "pr-content/sealed/${USERNAME}" /tmp/sealed-backup
            echo "sealed_folder=/tmp/sealed-backup" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âŒ No valid message found"
          exit 1

      # Checkout main repo for committing
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Internal Branch and Commit
        id: internal
        working-directory: main-repo
        run: |
          USERNAME="${{ steps.user.outputs.username }}"
          BRANCH_NAME="sealed-${USERNAME}-$(date +%s)"

          # Create new branch
          git checkout -b "$BRANCH_NAME"

          # Copy sealed files from temp folder
          mkdir -p "sealed/${USERNAME}"
          cp -r ${{ steps.process.outputs.sealed_folder }}/* "sealed/${USERNAME}/"

          # Configure git
          git config user.name "Time Capsule Bot"
          git config user.email "bot@github-time-capsule.local"

          # Commit
          git add sealed/
          git commit -m "ğŸ” Sealed message from @${USERNAME}"

          # Push internal branch
          git push origin "$BRANCH_NAME"

          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Merge Internal Branch to Main
        working-directory: main-repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ steps.internal.outputs.branch }}"

          # Merge directly
          git checkout main
          git pull origin main
          git merge "$BRANCH_NAME" --no-ff -m "Merge sealed message from @${{ steps.user.outputs.username }}"
          git push origin main

          # Delete internal branch
          git push origin --delete "$BRANCH_NAME"

      - name: Success Comment
        uses: actions/github-script@v7
        with:
          script: |
            const user = '${{ steps.user.outputs.username }}';
            const type = '${{ steps.process.outputs.type }}';

            const encryptionMethod = type === 'plaintext' 
              ? 'ğŸ” **Encrypted with GPG** (AES-256 + RSA-4096)' 
              : 'ğŸ”’ **Pre-encrypted** (Client-side encryption)';

            const message = `## ğŸ‰ Success! Your Message is Sealed! ğŸ•°ï¸

            <div align="center">

            ![Status](https://img.shields.io/badge/Status-âœ…_Sealed-success?style=for-the-badge)
            ![Unlock Date](https://img.shields.io/badge/Unlocks-January_1,_2035-blue?style=for-the-badge)

            </div>

            ---

            ### ğŸ‘¤ Message Details:

            | Item | Details |
            |------|---------|
            | **Submitter** | @${user} |
            | **Sealed At** | \`${new Date().toUTCString()}\` |
            | **Storage** | \`sealed/${user}/\` |
            | **Security** | ${encryptionMethod} |
            | **Unlock Date** | **January 1, 2035** ğŸ—“ï¸ |

            ---

            ### âœ… All Steps Completed:

            - âœ… **Validated** - Submission verified
            - âœ… **Encrypted** - Message secured with military-grade encryption
            - âœ… **Stored** - Saved in the time capsule vault
            - âœ… **Sealed** - Locked until 2035!

            ---

            ### ğŸ“¬ How to Receive Your Message in 2035:

            1. â­ **[Star this repository](../../stargazers)** to get notified
            2. ğŸ‘ï¸ **Watch â†’ All Activity** to receive updates
            3. ğŸ”” You'll get an email on **January 1, 2035** when it unlocks!

            ---

            <div align="center">

            ### ğŸŠ Thank You for Participating! ğŸŠ

            *Your message from ${new Date().getFullYear()} is now part of history.*

            **See you in 2035!** ğŸš€

            ---

            ![Time Capsule](https://img.shields.io/badge/â°-GitHub_Time_Capsule-purple?style=flat-square)

            ğŸ¤– *Automated by GitHub Actions*

            </div>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Failure Comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âŒ Submission Failed

            <div align="center">

            ![Status](https://img.shields.io/badge/Status-Failed-red?style=for-the-badge)

            </div>

            ---

            ### âš ï¸ What went wrong?

            The automated system could not process your message. This usually happens because:
            1. **Invalid Format:** The message file was not found or named correctly.
            2. **Duplicate:** You may have already submitted a message (check \`sealed/\` folder).
            3. **System Error:** A temporary issue with the encryption process.

            ### ğŸ› ï¸ How to fix:
            - If you used the **Web App**: Please try again in a few minutes.
            - If you submitted **Manually**: Ensure you created a file in \`messages/\` folder.

            *The PR will be closed automatically to keep the repository clean.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Close PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            await new Promise(r => setTimeout(r, 2000));
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });
