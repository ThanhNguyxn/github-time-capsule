name: ğŸ” Seal Time Capsule Message

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - "messages/**"
      - "sealed/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  seal:
    name: ğŸ”’ Encrypt & Seal
    runs-on: ubuntu-latest
    # Skip bot PRs
    if: |
      github.event.pull_request.user.login != 'dependabot[bot]' &&
      github.event.pull_request.user.login != 'vercel[bot]' &&
      github.event.pull_request.user.login != 'github-actions[bot]' &&
      !contains(github.event.pull_request.user.login, '[bot]')

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“‹ STEP 1: Comment "Processing..."
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¬ Comment - Processing
        uses: actions/github-script@v7
        with:
          script: |
            const body = `# ğŸ”„ Processing Your Time Capsule Message

            <div align="center">

            ![Processing](https://img.shields.io/badge/â³-Processing-orange?style=for-the-badge&labelColor=1a1a2e)

            </div>

            ---

            | Step | Status | Description |
            |:----:|:------:|:------------|
            | ğŸ” | â³ **Validating...** | Checking your submission |
            | ğŸ” | â¸ï¸ Queued | Encrypting with GPG |
            | ğŸ’¾ | â¸ï¸ Queued | Saving to vault |
            | âœ… | â¸ï¸ Queued | Finalizing |

            > â±ï¸ **Please wait...** This usually takes 10-30 seconds.

            ---

            <sub>ğŸ¤– Automated by GitHub Actions</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ STEP 2: Checkout PR content
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr-content

      - name: ğŸ‘¤ Extract username
        id: user
        run: echo "username=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” STEP 3: Find and encrypt message
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Process & Encrypt
        id: process
        env:
          GPG_KEY: ${{ secrets.GPG_PUBLIC_KEY }}
        run: |
          USERNAME="${{ steps.user.outputs.username }}"

          # Find message file (supports username.txt or username-*.txt)
          MESSAGE_FILE=""
          if [ -f "pr-content/messages/${USERNAME}.txt" ]; then
            MESSAGE_FILE="pr-content/messages/${USERNAME}.txt"
          else
            for f in pr-content/messages/${USERNAME}-*.txt; do
              if [ -f "$f" ]; then
                MESSAGE_FILE="$f"
                break
              fi
            done
          fi

          if [ -n "$MESSAGE_FILE" ]; then
            echo "type=plaintext" >> $GITHUB_OUTPUT
            echo "âœ… Found message: $MESSAGE_FILE"
            
            # Setup GPG
            echo "$GPG_KEY" | gpg --import
            
            # Encrypt to temp folder
            mkdir -p /tmp/sealed-output
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            
            gpg --encrypt \
                --recipient "time-capsule-2035" \
                --armor \
                --trust-model always \
                --output "/tmp/sealed-output/${USERNAME}-${TIMESTAMP}.gpg" \
                "$MESSAGE_FILE"
            
            echo "sealed_folder=/tmp/sealed-output" >> $GITHUB_OUTPUT
            echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for pre-sealed files
          if [ -d "pr-content/sealed/${USERNAME}" ]; then
            echo "type=sealed" >> $GITHUB_OUTPUT
            echo "âœ… Found pre-sealed message"
            cp -r "pr-content/sealed/${USERNAME}" /tmp/sealed-backup
            echo "sealed_folder=/tmp/sealed-backup" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âŒ No valid message found"
          exit 1

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¾ STEP 4: Commit directly to main (SINGLE COMMIT)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¥ Checkout Main
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¾ Commit to Main
        working-directory: main-repo
        run: |
          USERNAME="${{ steps.user.outputs.username }}"

          # Copy sealed files
          mkdir -p "sealed/${USERNAME}"
          cp -r ${{ steps.process.outputs.sealed_folder }}/* "sealed/${USERNAME}/"

          # Configure git
          git config user.name "Time Capsule Bot"
          git config user.email "bot@github-time-capsule.local"

          # Commit and push directly to main
          git add sealed/
          git commit -m "ğŸ” Sealed message from @${USERNAME}"
          git push origin main

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âœ… STEP 5: Success comment
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¬ Comment - Success
        uses: actions/github-script@v7
        with:
          script: |
            const user = '${{ steps.user.outputs.username }}';
            const type = '${{ steps.process.outputs.type }}';
            const encryptionMethod = type === 'plaintext' 
              ? 'ğŸ” GPG (AES-256 + RSA-4096)' 
              : 'ğŸ”’ Client-side Encryption';

            const message = `# ğŸ‰ Message Sealed Successfully!

            <div align="center">

            ![Success](https://img.shields.io/badge/âœ…-Sealed-success?style=for-the-badge&labelColor=1a1a2e)
            ![Unlock](https://img.shields.io/badge/ğŸ”“-January_1,_2035-blue?style=for-the-badge&labelColor=1a1a2e)

            </div>

            ---

            ## ï¿½ Details

            | Item | Value |
            |:-----|:------|
            | ğŸ‘¤ **Submitter** | @${user} |
            | ğŸ” **Encryption** | ${encryptionMethod} |
            | ğŸ“ **Location** | \`sealed/${user}/\` |
            | ğŸ“… **Sealed At** | \`${new Date().toUTCString()}\` |
            | ğŸ”“ **Unlocks** | **January 1, 2035** |

            ---

            ## âœ… Completed Steps

            | Step | Status |
            |:-----|:-------|
            | ğŸ” Validate | âœ… Passed |
            | ğŸ” Encrypt | âœ… Done |
            | ğŸ’¾ Store | âœ… Saved |
            | ğŸ”’ Seal | âœ… Locked |

            ---

            ## ğŸ“¬ Get Notified in 2035

            1. â­ **[Star this repo](../../stargazers)** to get updates
            2. ğŸ‘ï¸ **Watch â†’ All Activity** for notifications
            3. ğŸ”” You'll receive an email when it unlocks!

            ---

            <div align="center">

            ### ğŸŠ Thank You for Participating! ğŸŠ

            *Your message from ${new Date().getFullYear()} is now part of history.*

            **See you in 2035!** ğŸš€

            ---

            ![Time Capsule](https://img.shields.io/badge/ğŸ•°ï¸-GitHub_Time_Capsule-purple?style=flat-square)

            </div>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âŒ STEP 6: Failure comment (only runs on failure)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¬ Comment - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `# âŒ Submission Failed

            <div align="center">

            ![Failed](https://img.shields.io/badge/âŒ-Failed-red?style=for-the-badge&labelColor=1a1a2e)

            </div>

            ---

            ## âš ï¸ What Went Wrong?

            The system could not process your message. Possible reasons:

            | Issue | Description |
            |:------|:------------|
            | ğŸ“„ **File Not Found** | No valid file in \`messages/\` folder |
            | ğŸ”„ **Duplicate** | You may have already submitted |
            | âš™ï¸ **System Error** | Temporary encryption issue |

            ---

            ## ğŸ› ï¸ How to Fix

            - **Web App Users:** Try again in a few minutes
            - **Manual Users:** Ensure file is in \`messages/yourusername.txt\`
            - **Fork Issues:** [Sync your fork](../../network) with upstream

            ---

            <sub>ğŸ¤– This PR will be closed automatically</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸšª STEP 7: Close PR (always runs)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸšª Close PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            await new Promise(r => setTimeout(r, 2000));
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });
