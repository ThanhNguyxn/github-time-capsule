name: ğŸš¦ Rate Limit Check

on:
  pull_request_target:
    types: [opened]
    paths:
      - "messages/**"
  pull_request:
    types: [opened]
    paths:
      - "messages/**"

jobs:
  check-rate-limit:
    name: ğŸ” Check Submission Limit
    runs-on: ubuntu-latest
    # Skip bot PRs
    if: "!contains(github.event.pull_request.user.login, '[bot]')"

    steps:
      - name: ğŸ” Check User Activity
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USERNAME="${{ github.event.pull_request.user.login }}"
          REPO="${{ github.repository }}"

          echo "ğŸ” Checking recent PRs from @$USERNAME..."

          # Get PRs from this user in last 24 hours
          RECENT_PRS=$(gh pr list --repo $REPO --author $USERNAME --state all --limit 100 --json createdAt,number | \
            jq '[.[] | select(.createdAt >= (now - 86400 | strftime("%Y-%m-%dT%H:%M:%SZ")))] | length')

          echo "ğŸ“Š Recent PRs (24h): $RECENT_PRS"

          # Rate limit: Max 3 PRs per day
          if [ "$RECENT_PRS" -gt 3 ]; then
            echo "âŒ RATE LIMIT EXCEEDED"
            
            # Comment on PR
            gh pr comment ${{ github.event.pull_request.number }} --body "# âš ï¸ Rate Limit Exceeded

            <div align=\"center\">

            ![Rate Limit](https://img.shields.io/badge/â›”-Rate_Limit-red?style=for-the-badge&labelColor=1a1a2e)

            </div>

            ---

            ## ğŸ“Š Your Activity

            | Metric | Value |
            |:-------|:------|
            | ğŸ“¨ **PRs in 24h** | **$RECENT_PRS** |
            | ğŸš« **Limit** | 3 PRs/day |

            ---

            ## â“ Why This Limit?

            - ğŸ›¡ï¸ Prevents spam and abuse
            - âš–ï¸ Ensures fair usage for everyone
            - ğŸ“¦ You can only seal ONE message anyway!

            ---

            ## ğŸ› ï¸ What To Do

            1. â° Wait **24 hours** before trying again
            2. ğŸ’¡ If you need help, [open an issue](../../issues/new) instead

            ---

            <sub>ğŸ¤– This PR will be closed automatically</sub>"
            
            # Close PR
            gh pr close ${{ github.event.pull_request.number }} --comment "ğŸš« Closed due to rate limit"
            
            exit 1
          fi

          echo "âœ… Rate limit check passed ($RECENT_PRS/3 PRs used)"
