name: Rate Limit Check

on:
  pull_request_target:
    types: [opened]
  pull_request:
    types: [opened]

jobs:
  check-rate-limit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check user's recent activity
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USERNAME="${{ github.event.pull_request.user.login }}"
          REPO="${{ github.repository }}"
          
          echo "Checking recent PRs from @$USERNAME..."
          
          # Get PRs from this user in last 24 hours
          RECENT_PRS=$(gh pr list --repo $REPO --author $USERNAME --state all --limit 100 --json createdAt,number | \
            jq '[.[] | select(.createdAt >= (now - 86400 | strftime("%Y-%m-%dT%H:%M:%SZ")))] | length')
          
          echo "Recent PRs (24h): $RECENT_PRS"
          
          # Rate limit: Max 3 PRs per day
          if [ "$RECENT_PRS" -gt 3 ]; then
            echo "‚ùå RATE LIMIT: User has opened $RECENT_PRS PRs in last 24 hours"
            echo "Maximum: 3 PRs per day"
            echo ""
            echo "This is to prevent spam and abuse."
            echo "Please wait 24 hours before submitting another message."
            
            # Comment on PR
            gh pr comment ${{ github.event.pull_request.number }} --body "## ‚ö†Ô∏è Rate Limit Exceeded

**You've opened too many PRs recently ($RECENT_PRS in last 24 hours).**

**Limit:** 3 PRs per day per user

**Why?** To prevent spam and ensure fair usage for everyone.

**What to do:**
- Wait 24 hours before submitting another message
- You can only seal ONE message per user anyway
- If you need help, open an issue instead

This PR will be closed automatically."
            
            # Close PR
            gh pr close ${{ github.event.pull_request.number }} --comment "üö´ Closed due to rate limit"
            
            exit 1
          fi
          
          echo "‚úÖ Rate limit check passed"
