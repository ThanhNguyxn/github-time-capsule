name: ðŸ“Š Update Statistics

on:
  schedule:
    # Runs every day at 00:00 UTC
    - cron: '0 0 * * *'
  
  # Also run when a new message is sealed
  push:
    paths:
      - 'sealed/*.gpg'
  
  # Manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”¢ Count sealed messages
        id: count
        run: |
          # Count .gpg files in sealed/ folder (excluding .gitkeep)
          MESSAGE_COUNT=$(find sealed -name "*.gpg" -type f | wc -l)
          echo "MESSAGE_COUNT=$MESSAGE_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… Found $MESSAGE_COUNT sealed messages"

      - name: ðŸ“… Calculate days until 2035
        id: days
        run: |
          # Calculate days until January 1, 2035
          TARGET_DATE="2035-01-01"
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          # Calculate difference in days
          DAYS_UNTIL=$(( ($(date -d "$TARGET_DATE" +%s) - $(date -d "$CURRENT_DATE" +%s)) / 86400 ))
          
          echo "DAYS_UNTIL=$DAYS_UNTIL" >> $GITHUB_OUTPUT
          echo "âœ… Days until 2035: $DAYS_UNTIL"

      - name: âœï¸ Update README with new statistics
        run: |
          MESSAGE_COUNT="${{ steps.count.outputs.MESSAGE_COUNT }}"
          DAYS_UNTIL="${{ steps.days.outputs.DAYS_UNTIL }}"
          
          # Update Messages Sealed badge (handle both URL-encoded and plain formats)
          sed -i "s/Messages-Coming%20Soon-blue/Messages-${MESSAGE_COUNT}-blue/g" README.md
          sed -i "s/Messages-[0-9]*-blue/Messages-${MESSAGE_COUNT}-blue/g" README.md
          
          # Update Days Until 2035 badge (handle both URL-encoded and plain formats)
          sed -i "s/Countdown-[0-9]*%20days-orange/Countdown-${DAYS_UNTIL}%20days-orange/g" README.md
          sed -i "s/Countdown-[0-9]*-orange/Countdown-${DAYS_UNTIL}-orange/g" README.md
          
          echo "âœ… Updated README.md with new statistics"
          echo "   - Messages Sealed: $MESSAGE_COUNT"
          echo "   - Days Until 2035: $DAYS_UNTIL"

      - name: ðŸ“Š Check if there are changes
        id: verify
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
            git diff README.md
          fi

      - name: ðŸ’¾ Commit and push changes
        if: steps.verify.outputs.changed == 'true'
        run: |
          git config user.name "Statistics Bot"
          git config user.email "bot@timecapsule.dev"
          git add README.md
          git commit -m "ðŸ“Š Auto-update statistics: ${{ steps.count.outputs.MESSAGE_COUNT }} messages, ${{ steps.days.outputs.DAYS_UNTIL }} days until 2035"
          git push origin main
          echo "âœ… Pushed changes to repository"

      - name: ðŸŽ‰ Summary
        run: |
          echo "### ðŸ“Š Statistics Update Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Messages Sealed | ${{ steps.count.outputs.MESSAGE_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Days Until 2035 | ${{ steps.days.outputs.DAYS_UNTIL }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Changes Made | ${{ steps.verify.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
